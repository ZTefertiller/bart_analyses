---
title: "model_plotting"
author: "Zach Tefertiller"
date: "2025-03-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, libraries}
library(dplyr)
library(bayesplot)
library(ggplot2)
library(rstan)
library(pryr)
library(loo)
library(gganimate)
library(reshape2)
```

```{r trace plot}
# function for trace plot of main group parameters
plot_group_trace <- function(fit_obj, warmup = NULL, iter = NULL) {
  color_scheme_set(c( "#BF6CAF", "#80384B", "#FF595E","#404A9C", "#7F7EFF", "#011638"))
  fit_name <- deparse(substitute(fit_obj))
  if (is.null(warmup)) {
    warmup <- fit_obj@sim$warmup
  }
  if (is.null(iter)) {
    iter <- fit_obj@sim$iter
  }
  cat("Warmup iterations:", warmup, "\n")
  cat("Total iterations:", iter, "\n")
  
  
  # cant get warmup shading right
draws <- as.array(fit_obj, pars = c("mu_vwin", "mu_vloss", "mu_omegaone", "mu_beta"))
traceplot_params <- mcmc_trace(draws, pars = c("mu_vwin", "mu_vloss", "mu_omegaone", "mu_beta"),          n_warmup = 0, np_style = trace_style_np())
  traceplot_params <- traceplot_params + 
                        labs(title = "Group Level Parameter Simulations") +
                        theme(
                          panel.spacing = unit(3, "lines"),
                          plot.title = element_text(hjust = 0.5),
                          text = element_text(family = "Courier New", face = "bold")
                        ) +
                        facet_wrap(~parameter, scales = "free_y", labeller = as_labeller(c(
                        mu_vwin = "Learning Rate for Wins", 
                        mu_vloss = "Learning Rate for Losses", 
                        mu_omegaone = "Estimated Number of Pumps",
                        mu_beta = "Behavioural Consistency")
                        )) +
                        scale_x_continuous(limits = c(0, 2000))
 ggsave(filename = paste0("/Users/zachtefertiller/Desktop/", fit_name, ".png"), 
         plot = traceplot_params, dpi = 500, width = 8, height = 6, bg = "white")
  print(traceplot_params)
}
```

```{r}
# -------------------------------------------------------------------
# Trace plot for ALL group-level parameters in the scaled-target model
# -------------------------------------------------------------------
library(bayesplot)   # mcmc_trace()
library(ggplot2)
library(stringr)     # str_replace_all()

plot_group_trace_all <- function(fit_obj,
                                 warmup = NULL,
                                 iter   = NULL,
                                 save_to = "~/Desktop") {
  
  ## 1. basic housekeeping  -----------------------------------------
  fit_name <- deparse(substitute(fit_obj))
  warmup   <- fit_obj@sim$warmup
  iter_post <- fit_obj@sim$iter               # post-warm-up only
  iter_tot  <- warmup + iter_post             # ← 2000 in your run
  
  message("Warm-up iterations: ", warmup)
  message("Post-warm-up iterations: ", iter_post)
  message("Total stored iterations: ", iter_tot)
  
    
  ## 2. pull the parameter names we care about ----------------------
  all_pars <- fit_obj@sim$pars_oi              # character vector
  group_pars <- grep("^[boy]_mu_", all_pars, value = TRUE)
  
  if (length(group_pars) == 0)
    stop("Couldn’t find any parameters named b_mu_ / o_mu_ / y_mu_…",
         call. = FALSE)
  
  ## 3. helper: prettify labels -------------------------------------
    nice_label <- function(x) {
      x <- str_replace_all(x, "^b_",  "Blue ")
      x <- str_replace_all(x, "^o_",  "Orange ")
      x <- str_replace_all(x, "^y_",  "Yellow ")
      x <- str_replace_all(x, "mu_",  "")
      x <- str_replace_all(x, "_omegaone", " ω₁")
      x <- str_replace_all(x, "_beta",     " β")
      x <- str_replace_all(x, "_vwin",     " v-win")
      x <- str_replace_all(x, "_vloss",    " v-loss")
      x <- str_replace_all(x, "_pre$",     " (pre)")
      x <- str_replace_all(x, "_post$",    " (post)")
      x <- str_replace_all(x, "_",         " ")
      x
    }

  labeller_vec <- setNames(vapply(group_pars, nice_label, ""), group_pars)
  
  ## 4. pull draws & make trace plot --------------------------------
  color_scheme_set(c("#BF6CAF", "#80384B", "#FF595E",
                   "#404A9C", "#7F7EFF", "#011638"))

draws <- rstan::extract(
           fit_obj,
           pars       = group_pars,
           permuted   = FALSE,   # (iter × chain × param)
           inc_warmup = TRUE
         )                       # ← no duplication here

tr <- mcmc_trace(
        draws,
        pars       = group_pars,
        facet_args = list(ncol = 4),
        np_style   = trace_style_np(),
        n_warmup   = warmup
      ) +
      facet_wrap(~parameter,
                 scales   = "free_y",
                 ncol     = 4,
                 labeller = as_labeller(labeller_vec)) +
      labs(title = "Group-level parameter traces") +
      theme(
        panel.spacing = unit(3, "lines"),
        plot.title    = element_text(hjust = 0.5),
        text          = element_text(family = "Courier New", face = "bold")
      ) +
      scale_x_continuous(limits = c(0, iter_tot))
  
  ## 5. save and return --------------------------------------------
  outfile <- file.path(save_to, paste0(fit_name, "_group_trace.png"))
  ggsave(outfile, tr, dpi = 500, width = 10, height = 8, bg = "white")
  
  message("Saved → ", outfile)
  tr
}

```

```{r}
vwin_vloss_reversal <- function(group1, group2, color) {

# get draws by gorup
draws_high <- as.array(group1, pars = c("vwin", "vloss"))
draws_low  <- as.array(group2, pars = c("vwin", "vloss"))

# 2. If one model has an extra index (e.g., 21), subset to only indices 1 to 20.
subset_pars <- function(draws) {
  param_names <- dimnames(draws)[[3]]
  keep <- grepl("\\[(?:[1-9]|1[0-9]|20)\\]", param_names)
  draws[ , , keep, drop = FALSE]
}

draws_high <- subset_pars(draws_high)
draws_low  <- subset_pars(draws_low)

#  convert array to df
df_high <- as.data.frame.table(draws_high, responseName = "value", stringsAsFactors = FALSE)
df_low  <- as.data.frame.table(draws_low,  responseName = "value", stringsAsFactors = FALSE)

# rename columns in as.data.frame.table: var1 -> iteration, var2 -> chain, var3 -> parameter
names(df_high)[1:3] <- c("Iteration", "Chain", "Parameter")
names(df_low)[1:3]  <- c("Iteration", "Chain", "Parameter")

df_high <- df_high %>% mutate(Group = "High Scorers")
df_low  <- df_low %>% mutate(Group = "Low Scorers")
df <- bind_rows(df_high, df_low)

df <- df %>%
  mutate(
    ParType = ifelse(grepl("vwin", Parameter), "vwin", "vloss"),
    ParticipantID = as.numeric(gsub(".*\\[([0-9]+)\\]", "\\1", Parameter))
  )

participant_summary <- df %>%
  group_by(Group, ParticipantID, ParType) %>%
  summarise(
    mean_value = mean(value),
    lower_cred = quantile(value, 0.025),
    upper_cred = quantile(value, 0.975),
    .groups = 'drop'
  )

# average learning rate per param by group
group_summary <- participant_summary %>%
  group_by(Group, ParType) %>%
  summarise(
    group_mean = mean(mean_value),
    group_lower = quantile(mean_value, 0.025),
    group_upper = quantile(mean_value, 0.975),
    .groups = 'drop'
  )

t_test_vwin <- t.test(mean_value ~ Group, data = participant_summary %>% filter(ParType == "vwin"))
t_test_vloss <- t.test(mean_value ~ Group, data = participant_summary %>% filter(ParType == "vloss"))

print(t_test_vwin)
print(t_test_vloss)

print(group_summary)

ggplot(participant_summary, aes(x = ParType, y = mean_value, fill = Group)) +
  geom_boxplot() +
  labs(title = paste0("Learning Rates by Group - ", color), 
       x = "Parameters",
       y = "Posterior Participant Means") +
  theme_minimal() +
  theme(text = element_text(family = "Courier New", face = "bold"))

ggsave(filename = paste0(color, "_learning_rate_comparison.png"),
       plot = last_plot(),
       width = 8, height = 6, dpi = 300, bg = "#FDE992")
}

```

```{r animated heatmap matrix evo}

# Assuming theta_samples is an array of dimensions [iterations, rows, cols]
n_iter <- dim(theta_samples)[1]
n_rows <- dim(theta_samples)[2]
n_cols <- dim(theta_samples)[3]

# Build a data frame with a row for each element at each iteration
df <- do.call(rbind, lapply(1:n_iter, function(i) {
  m <- theta_samples[i, , ]
  df_temp <- melt(m)
  df_temp$Iteration <- i
  df_temp
}))

# Create the animated heatmap
p <- ggplot(df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_y_reverse() +
  labs(title = 'Iteration: {frame_time}') +
  transition_time(Iteration) +
  ease_aes('linear')

animate(p, nframes = n_iter)


```

```{r}
ppc_scatterplot <- function(df, trial_number, model_name = "stl") {
    if (model_name == "stl"){
      model = "stl_predicted_pumps"
    }
    else if (model_name == "ewmv"){
      model = "ewmv_predicted_pumps"
    }
    df_trial <- df %>% filter(trial_number == trial_number)
    ppc_scatter(
    y = df_trial$inflations,
    yrep = matrix(df_trial[[model_col]], nrow = 1))
    # df %>% filter(trial_number == trial_number)
    #   ppc_scatter(
    #     y = df$inflations,
    #     yrep = matrix(df$model, nrow = 1))
}
```




```{r OLD intervals plot}
# intervals plot
interval_plot <- mcmc_intervals(draws, pars= group_factors, prob = 0.5)
ggsave(filename = "/Users/zachtefertiller/Desktop/test.png", 
       plot = interval_plot, dpi = 500, width = 9, height = 7, bg = "white")
```

```{r}
# density plot
density_plot <- mcmc_dens_overlay(draws, pars = group_factors)
ggsave(filename = "/Users/zachtefertiller/Desktop/STL_mcmc/2000_all_participants_density.png", 
       plot = density_plot, dpi = 500, width = 9, height = 7, bg = "white")
```


```{r}

df_plot <- data.frame(
  trial = 1:180,
  omega = omega_out_mean[1, ]
)

ggplot(df_plot, aes(x = trial, y = omega)) +
  geom_line() +
  labs(title = "Predicted Omega Across Trials (Participant 1)",
       x = "Trial", y = "Omega") +
  theme_minimal()


balloon_colors <- stl_stan_data$balloon_color


participant_id <- 1

# Make a dataframe for plotting
df_plot <- data.frame(
  trial = 1:180,
  omega = omega_out_mean[participant_id, ],
  color = factor(balloon_colors[participant_id, ],
                 levels = c(1,2,3),
                 labels = c("Blue", "Orange", "Yellow"))
)

# Now plot
ggplot(df_plot, aes(x = trial, y = omega, color = color)) +
  geom_point(size = 2) +
  labs(
    title = paste("Predicted Omega Across Trials (Participant", participant_id, ")"),
    x = "Trial",
    y = "Omega",
    color = "Balloon Color"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("blue", "orange", "yellow"))

```


```{r}
# -------------------------------------------------------------------
# Trace plot for ALL group-level μ-parameters in the scaled-target model
# -------------------------------------------------------------------
library(bayesplot)
library(ggplot2)
library(stringr)

plot_group_trace_all <- function(fit_obj,
                                 warmup = fit_obj@sim$warmup,
                                 mask   = warmup,      # how many draws to ignore for y-range
                                 drop_x_mask = FALSE,  # TRUE → x starts right after 'mask'
                                 save_to = "~/Desktop") {

  ## bookkeeping ----------------------------------------------------
  iter_post <- fit_obj@sim$iter
  iter_tot  <- warmup + iter_post
  message("Warm-up iterations:  ", warmup)
  message("Post-warm-up iters:  ", iter_post)
  message("Total stored iters:  ", iter_tot)

  ## parameter names ------------------------------------------------
  group_pars <- grep("^[boy]_mu_", fit_obj@sim$pars_oi, value = TRUE)
  stopifnot(length(group_pars) > 0)

  ## nice labels ----------------------------------------------------
  nice_label <- function(x) {
    x <- str_replace_all(x, "^b_",  "Blue ")
    x <- str_replace_all(x, "^o_",  "Orange ")
    x <- str_replace_all(x, "^y_",  "Yellow ")
    x <- str_replace_all(x, "mu_",  "")
    x <- str_replace_all(x, "_omegaone", " ω₁")
    x <- str_replace_all(x, "_beta",     " β")
    x <- str_replace_all(x, "_vwin",     " v-win")
    x <- str_replace_all(x, "_vloss",    " v-loss")
    x <- str_replace_all(x, "_pre$",     " (pre)")
    x <- str_replace_all(x, "_post$",    " (post)")
    str_replace_all(x, "_", " ")
  }
  labeller_vec <- setNames(vapply(group_pars, nice_label, ""), group_pars)

  ## draws ----------------------------------------------------------
  draws_full <- rstan::extract(
               fit_obj,
               pars       = group_pars,
               permuted   = FALSE,
               inc_warmup = TRUE
             )

  draws <- draws_full                             # copy
  if (mask > 0) {
    keep_row <- mask + 1                          # first row *after* mask
    draws[seq_len(mask), , ] <- draws_full[keep_row, , ]
    # now the first `mask` rows are flat lines at a realistic value
  }
  ## build trace plot ----------------------------------------------
  color_scheme_set(c("#BF6CAF", "#80384B", "#FF595E",
                     "#404A9C", "#7F7EFF", "#011638"))

  tr <- mcmc_trace(
          draws,
          pars       = group_pars,
          facet_args = list(ncol = 4),
          np_style   = trace_style_np(),
          n_warmup   = warmup
        ) +
        facet_wrap(~parameter,
                   scales   = "free_y",
                   ncol     = 4,
                   labeller = as_labeller(labeller_vec)) +
        labs(title = "Group-level parameter traces") +
        theme(
          panel.spacing = unit(3, "lines"),
          plot.title    = element_text(hjust = 0.5),
          text          = element_text(family = "Courier New", face = "bold")
        )

  # x-axis range
  if (drop_x_mask) {
    tr <- tr + scale_x_continuous(limits = c(mask, iter_tot))
  } else {
    tr <- tr + scale_x_continuous(limits = c(0, iter_tot))
  }

  ## save and return ------------------------------------------------
  outfile <- file.path(save_to,
                       paste0(deparse(substitute(fit_obj)), "_group_trace.png"))
  ggsave(outfile, tr, dpi = 500, width = 10, height = 8, bg = "white")
  message("Saved → ", outfile)
  tr
}
```


```{r}
#little checker for omega for a specific participant
plot(mean[1, ], type = "l")
abline(v = 91, lty = 2, col = "grey")

#or everyone's
## oo:  draws × subjects × trials  (from rstan::extract)
post_mean <- apply(oo, c(2, 3), mean)   # subjects × trials

matplot( t(post_mean),                   # transpose → trials on x-axis
         type = "l", lty = 1, lwd = .8,
         col = adjustcolor("black", .25),
         xlab = "Trial",
         ylab = "Optimal pumps (ω)")

abline(v = 91, lty = 2, col = "grey40")  # reversal point
```




