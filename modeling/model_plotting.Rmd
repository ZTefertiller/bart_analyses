---
title: "model_plotting"
author: "Zach Tefertiller"
date: "2025-03-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, libraries}
library(dplyr)
library(bayesplot)
library(ggplot2)
library(rstan)
library(pryr)
library(loo)
library(gganimate)
library(reshape2)
```

```{r trace plot}
# function for trace plot of main group parameters
plot_group_trace <- function(fit_obj, warmup = NULL, iter = NULL) {
  color_scheme_set(c( "#BF6CAF", "#80384B", "#FF595E","#404A9C", "#7F7EFF", "#011638"))
  fit_name <- deparse(substitute(fit_obj))
  if (is.null(warmup)) {
    warmup <- fit_obj@sim$warmup
  }
  if (is.null(iter)) {
    iter <- fit_obj@sim$iter
  }
  cat("Warmup iterations:", warmup, "\n")
  cat("Total iterations:", iter, "\n")
  
  
  # cant get warmup shading right
draws <- as.array(fit_obj, pars = c("mu_vwin", "mu_vloss", "mu_omegaone", "mu_beta"))
traceplot_params <- mcmc_trace(draws, pars = c("mu_vwin", "mu_vloss", "mu_omegaone", "mu_beta"),          n_warmup = 0, np_style = trace_style_np())
  traceplot_params <- traceplot_params + 
                        labs(title = "Group Level Parameter Simulations") +
                        theme(
                          panel.spacing = unit(3, "lines"),
                          plot.title = element_text(hjust = 0.5),
                          text = element_text(family = "Courier New", face = "bold")
                        ) +
                        facet_wrap(~parameter, scales = "free_y", labeller = as_labeller(c(
                        mu_vwin = "Learning Rate for Wins", 
                        mu_vloss = "Learning Rate for Losses", 
                        mu_omegaone = "Estimated Number of Pumps",
                        mu_beta = "Behavioural Consistency")
                        )) +
                        scale_x_continuous(limits = c(0, 2000))
 ggsave(filename = paste0("/Users/zachtefertiller/Desktop/", fit_name, ".png"), 
         plot = traceplot_params, dpi = 500, width = 8, height = 6, bg = "white")
  print(traceplot_params)
}
```


```{r}
vwin_vloss_reversal <- function(group1, group2, color) {

# get draws by gorup
draws_high <- as.array(blue_high_spq, pars = c("vwin", "vloss"))
draws_low  <- as.array(blue_all, pars = c("vwin", "vloss"))

# 2. If one model has an extra index (e.g., 21), subset to only indices 1 to 20.
subset_pars <- function(draws) {
  param_names <- dimnames(draws)[[3]]
  keep <- grepl("\\[(?:[1-9]|1[0-9]|20)\\]", param_names)
  draws[ , , keep, drop = FALSE]
}

draws_high <- subset_pars(draws_high)
draws_low  <- subset_pars(draws_low)

#  convert array to df
df_high <- as.data.frame.table(draws_high, responseName = "value", stringsAsFactors = FALSE)
df_low  <- as.data.frame.table(draws_low,  responseName = "value", stringsAsFactors = FALSE)

# rename columns in as.data.frame.table: var1 -> iteration, var2 -> chain, var3 -> parameter
names(df_high)[1:3] <- c("Iteration", "Chain", "Parameter")
names(df_low)[1:3]  <- c("Iteration", "Chain", "Parameter")

df_high <- df_high %>% mutate(Group = "High Scorers")
df_low  <- df_low %>% mutate(Group = "Low Scorers")
df <- bind_rows(df_high, df_low)

df <- df %>%
  mutate(
    ParType = ifelse(grepl("vwin", Parameter), "vwin", "vloss"),
    ParticipantID = as.numeric(gsub(".*\\[([0-9]+)\\]", "\\1", Parameter))
  )

participant_summary <- df %>%
  group_by(Group, ParticipantID, ParType) %>%
  summarise(
    mean_value = mean(value),
    lower_cred = quantile(value, 0.025),
    upper_cred = quantile(value, 0.975),
    .groups = 'drop'
  )

# average learning rate per param by group
group_summary <- participant_summary %>%
  group_by(Group, ParType) %>%
  summarise(
    group_mean = mean(mean_value),
    group_lower = quantile(mean_value, 0.025),
    group_upper = quantile(mean_value, 0.975),
    .groups = 'drop'
  )

t_test_vwin <- t.test(mean_value ~ Group, data = participant_summary %>% filter(ParType == "vwin"))
t_test_vloss <- t.test(mean_value ~ Group, data = participant_summary %>% filter(ParType == "vloss"))

print(t_test_vwin)
print(t_test_vloss)

print(group_summary)

ggplot(participant_summary, aes(x = ParType, y = mean_value, fill = Group)) +
  geom_boxplot() +
  labs(title = paste0("Learning Rates by Group - ", color), 
       x = "Parameters",
       y = "Posterior Participant Means") +
  theme_minimal() +
  theme(text = element_text(family = "Courier New", face = "bold"))

ggsave(filename = paste0(color, "_learning_rate_comparison.png"),
       plot = last_plot(),
       width = 8, height = 6, dpi = 300, bg = "#FDE992")
}

```

```{r animated heatmap matrix evo}

# Assuming theta_samples is an array of dimensions [iterations, rows, cols]
n_iter <- dim(theta_samples)[1]
n_rows <- dim(theta_samples)[2]
n_cols <- dim(theta_samples)[3]

# Build a data frame with a row for each element at each iteration
df <- do.call(rbind, lapply(1:n_iter, function(i) {
  m <- theta_samples[i, , ]
  df_temp <- melt(m)
  df_temp$Iteration <- i
  df_temp
}))

# Create the animated heatmap
p <- ggplot(df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_y_reverse() +
  labs(title = 'Iteration: {frame_time}') +
  transition_time(Iteration) +
  ease_aes('linear')

animate(p, nframes = n_iter)


```






```{r OLD intervals plot}
# intervals plot
interval_plot <- mcmc_intervals(draws, pars= group_factors, prob = 0.5)
ggsave(filename = "/Users/zachtefertiller/Desktop/test.png", 
       plot = interval_plot, dpi = 500, width = 9, height = 7, bg = "white")
```

```{r}
# density plot
density_plot <- mcmc_dens_overlay(draws, pars = group_factors)
ggsave(filename = "/Users/zachtefertiller/Desktop/STL_mcmc/2000_all_participants_density.png", 
       plot = density_plot, dpi = 500, width = 9, height = 7, bg = "white")
```
